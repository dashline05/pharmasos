---
import { LOCALES, useTranslations, type Lang } from "@/i18n";
import Layout from "@/layouts/Base.astro";
import pharmacyData from "@/data/pharmacyData.json";

interface CityInfo {
  name: {
    fr: string;
    en: string;
    ar: string;
  };
  count: number;
  open24h: number;
}

type LocaleKey = keyof CityInfo['name'];

const validLanguages = ['en', 'fr', 'ar'] as const;
type ValidLanguage = typeof validLanguages[number];

export function getStaticPaths() {
  return validLanguages.map(lang => ({
    params: { lang }
  }));
}

const { lang } = Astro.params;
const currentLang = validLanguages.includes(lang as ValidLanguage) ? lang as ValidLanguage : 'fr';

const translations = {
  title: {
    fr: "Accueil",
    en: "Home",
    ar: "الرئيسية"
  },
  welcome: {
    fr: "Bienvenue sur PharmaGarde",
    en: "Welcome to PharmaGarde",
    ar: "مرحباً بكم في فارماغارد"
  }
} as const;

const t = useTranslations(currentLang as Lang);

const cities: Record<string, CityInfo> = pharmacyData.pharmacies
  .filter(pharmacy => pharmacy?.city?.[currentLang])
  .reduce((acc: Record<string, CityInfo>, pharmacy) => {
    const cityName = pharmacy.city[currentLang];
    if (!cityName) return acc;

    if (!acc[cityName]) {
      acc[cityName] = {
        name: pharmacy.city,
        count: 1,
        open24h: String(pharmacy.hours || '').includes('24h') ? 1 : 0
      };
    } else {
      acc[cityName].count++;
      if (String(pharmacy.hours || '').includes('24h')) {
        acc[cityName].open24h++;
      }
    }
    return acc;
  }, {});

const cityList = Object.values(cities)
  .sort((a: CityInfo, b: CityInfo) => 
    a.name[currentLang].localeCompare(b.name[currentLang])
  );

// For debugging
console.log('Available cities:', cityList.map(city => city.name[currentLang]));

const lastUpdated = new Date(pharmacyData.date).toLocaleDateString();
---

<Layout title={translations.title[currentLang]}>
  <div class="home-page">
    <h1>{translations.welcome[currentLang]}</h1>
    <!-- Home page content here -->
  </div>
</Layout>

<style>
  .home-page {
    padding: 2rem;
    text-align: center;
  }

  h1 {
    font-size: 2.5rem;
    margin-bottom: 2rem;
  }
</style>